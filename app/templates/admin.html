<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - AI Developer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/chat-fix.css">
    <style>
        .sidebar { transition: all 0.3s; }
        .chat-panel { transition: all 0.3s; }
        .active-tab { background-color: #3b82f6; color: white; }
        .active-tab span { color: white !important; }
        .message-admin { background-color: #3b82f6; color: white; margin-left: auto; }
        .message-user { background-color: #e5e7eb; color: #1f2937; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        #chat-input {
            color: #000000 !important;
            -webkit-text-fill-color: #000000 !important;
            opacity: 1 !important;
            font-weight: 400 !important;
            background-color: #ffffff !important;
        }
        
        #chat-input::placeholder {
            color: #666666 !important;
            opacity: 1 !important;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .ws-connected { color: #10b981; }
        .ws-disconnected { color: #ef4444; }
        .ws-connecting { color: #f59e0b; }
        
        .message-edit-mode {
            background-color: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        
        .edit-textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            background-color: #fff9e6;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-textarea:focus {
            outline: none;
            border-color: #d97706;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        
        .edit-save-btn {
            background-color: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .edit-save-btn:hover {
            background-color: #059669;
        }
        
        .edit-cancel-btn {
            background-color: #6b7280;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .edit-cancel-btn:hover {
            background-color: #4b5563;
        }
        
        .stat-highlight {
            animation: statPulse 0.5s ease-in-out;
        }
        
        @keyframes statPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #8b5cf6; }
            100% { transform: scale(1); }
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #000000 !important;
            background-color: #ffffff !important;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px solid #93c5fd;
            background-color: #ffffff !important;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af !important;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn.edit {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        
        .action-btn.edit:hover {
            background-color: #d1d5db;
        }
        
        .action-btn.delete {
            background-color: #fee2e2;
            color: #ef4444;
        }
        
        .action-btn.delete:hover {
            background-color: #fecaca;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge.admin {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .badge.user {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        /* Выпадающий список пользователей */
        .user-list-dropdown {
            position: absolute;
            z-index: 50;
            width: 250px;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
        }
        
        .user-list-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }
        
        .user-list-item:hover {
            background-color: #f3f4f6;
        }
        
        .user-list-item .name {
            font-weight: 500;
            color: #1f2937;
        }
        
        .user-list-item .email {
            font-size: 12px;
            color: #6b7280;
        }

        /* Стили для карточки клиента */
        .client-card-section {
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .client-card-section h4 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .details-item {
            font-size: 14px;
        }
        
        .details-item .label {
            color: #6b7280;
            margin-right: 8px;
        }
        
        .details-item .value {
            color: #1f2937;
            font-weight: 500;
        }

        /* Стили для таблицы договоров */
        .contracts-table-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .contracts-table-scroll {
            min-width: 2200px;
        }
        .contracts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .contracts-table th {
            background-color: #f9fafb;
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }
        .contracts-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
            vertical-align: middle;
        }
        .contracts-table tr:hover {
            background-color: #f9fafb;
        }
        .contract-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .contract-cell.expanded {
            white-space: normal;
            word-wrap: break-word;
            background-color: #fef9e7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 4px !important;
        }
        .contract-cell .expand-icon {
            opacity: 0.5;
            font-size: 12px;
            margin-left: 4px;
        }
        .contract-cell:hover .expand-icon {
            opacity: 1;
        }
        .progress-bar-container {
            width: 100px;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 10px;
        }
        .contract-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }
        .status-draft { background-color: #f3f4f6; color: #4b5563; }
        .status-active { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .filter-section {
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Стили для интерактивной таблицы проектов */
        .project-cell {
            cursor: pointer;
            transition: all 0.2s;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .project-cell.expanded {
            white-space: normal;
            word-wrap: break-word;
            max-width: none;
            background-color: #fef9e7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 8px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .project-cell .expand-icon {
            opacity: 0.5;
            font-size: 12px;
            margin-left: 4px;
        }
        .project-cell:hover .expand-icon {
            opacity: 1;
        }
        .project-folder-btn {
            background-color: #f3f4f6;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: #374151;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .project-folder-btn:hover {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .status-selector {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-in_progress { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .project-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .project-actions button {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">AI Developer Portal - Админ-панель</h1>
                <span class="bg-blue-800 px-3 py-1 rounded-full text-sm">Администратор</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="admin-email" class="font-medium">Загрузка...</span>
                <a href="/" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded transition flex items-center">
                    <span class="mr-2">🏠</span> Главная
                </a>
                <a href="/dashboard" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition">В личный кабинет</a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">Выход</button>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto flex mt-4 gap-4" style="min-height: calc(100vh - 140px);">
        <div class="sidebar w-64 bg-white rounded-lg shadow-lg p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">📊 Навигация</h2>
            <div class="space-y-1">
                <button onclick="loadTab('users')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center text-gray-800 font-medium" id="tab-users">
                    <span class="mr-2 text-gray-700">👤</span> <span class="text-gray-800">Пользователи</span>
                </button>
                
                <!-- КНОПКА ДОГОВОРА -->
                <button onclick="loadTab('contracts')" class="tab-btn w-full text-left p-3 rounded hover:bg-amber-50 transition flex items-center text-gray-800 font-medium" id="tab-contracts">
                    <span class="mr-2 text-amber-600">📄</span> <span class="text-gray-800">Договора</span>
                </button>
                
                <button onclick="loadTab('payments')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center text-gray-800 font-medium" id="tab-payments">
                    <span class="mr-2 text-gray-700">💰</span> <span class="text-gray-800">Платежи</span>
                </button>
                <button onclick="loadTab('projects')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center text-gray-800 font-medium" id="tab-projects">
                    <span class="mr-2 text-gray-700">📁</span> <span class="text-gray-800">Проекты</span>
                </button>
                <button onclick="loadTab('work-materials')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center text-gray-800 font-medium" id="tab-work-materials">
                    <span class="mr-2 text-gray-700">⚙️</span> <span class="text-gray-800">Рабочие материалы</span>
                </button>
                <button onclick="loadTab('archive')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center text-gray-800 font-medium" id="tab-archive">
                    <span class="mr-2 text-gray-700">📦</span> <span class="text-gray-800">Архив</span>
                </button>
            </div>
            
            <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                <h3 class="font-bold mb-3 text-gray-700 flex items-center">
                    <span class="mr-2">🚀</span> Быстрая статистика
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">👤 Пользователи:</span>
                        <span id="stats-users" class="font-bold text-blue-600 text-lg" data-stat="users">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">📁 Проекты:</span>
                        <span id="stats-projects" class="font-bold text-green-600 text-lg" data-stat="projects">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">🛠️ Услуги:</span>
                        <span id="stats-services" class="font-bold text-yellow-600 text-lg" data-stat="services">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💬 Сообщения:</span>
                        <span id="stats-messages" class="font-bold text-purple-600 text-lg" data-stat="messages">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💰 Транзакции:</span>
                        <span id="stats-transactions" class="font-bold text-red-600 text-lg" data-stat="transactions">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex-1 bg-white rounded-lg shadow-lg p-6 overflow-y-auto">
            <div class="p-5 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-blue-200 shadow-sm mb-6">
                <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center">
                    <span class="mr-2">👨‍💻</span> Панель разработчика
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                    <button onclick="testWebSocket()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔌</span> Тест WebSocket
                    </button>
                    <button onclick="clearCache()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🧹</span> Очистить кэш
                    </button>
                    <button onclick="reloadData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔄</span> Обновить данные
                    </button>
                </div>
                <div class="bg-gray-900 text-green-400 rounded-lg p-3 font-mono text-sm h-40 overflow-y-auto mb-6" id="dev-console">
                    <div class="text-gray-400">// Консоль разработчика</div>
                    <div>> Система инициализируется...</div>
                </div>
            </div>

            <div id="content-area" class="mt-6">
                <!-- Контент будет загружаться сюда -->
            </div>
        </div>
        
        <div class="chat-panel w-80 bg-white rounded-lg shadow-lg flex flex-col">
            <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center">
                        <span class="mr-2">💬</span> Чат поддержки
                    </h2>
                    <span id="chat-status" class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Онлайн
                    </span>
                </div>
                <div class="flex space-x-2 mb-3">
                    <div class="relative flex-1">
                        <input type="text" id="chat-search" placeholder="Поиск пользователя..."
                               class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                               onfocus="loadUserDropdown()" oninput="filterUsers()">
                        <div id="user-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                            <div class="p-2 text-gray-500 text-center">Загрузка пользователей...</div>
                        </div>
                    </div>
                    <button onclick="refreshChatList()" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
                        🔄
                    </button>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col p-3" id="chat-window">
                <div class="flex-1 overflow-y-auto mb-3 p-3 bg-gray-50 rounded-lg" id="chat-messages-container">
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-3xl mb-2">💬</div>
                        <p>Выберите пользователя для начала общения</p>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="flex space-x-2 mb-2 items-stretch">
                        <textarea id="chat-input" placeholder="Введите сообщение..." 
                                  class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none" 
                                  rows="2" onkeydown="handleChatKeydown(event)"></textarea>
                        <button onclick="sendAdminMessage()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center whitespace-nowrap font-medium h-auto">
                            Отправить
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="editLastMessage()" class="text-sm text-gray-500 hover:text-gray-700">
                            ✏️ Редактировать сообщение
                        </button>
                        <div class="text-xs text-gray-400">
                            Enter - отправить, Shift+Enter - новая строка
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно добавления/редактирования пользователя -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Добавить пользователя</h2>
            <form id="user-form" onsubmit="saveUser(event)">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label for="user-name">Имя</label>
                    <input type="text" id="user-name" required>
                </div>
                <div class="form-group">
                    <label for="user-email">Email</label>
                    <input type="email" id="user-email" required>
                </div>
                <div class="form-group">
                    <label for="user-password">Пароль</label>
                    <input type="password" id="user-password" placeholder="Оставьте пустым, если не меняете">
                </div>
                <div class="form-group">
                    <label for="user-is-admin">Роль</label>
                    <select id="user-is-admin">
                        <option value="false">Пользователь</option>
                        <option value="true">Администратор</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Подтверждение удаления</h2>
            <p class="mb-6">Вы уверены, что хотите удалить пользователя <span id="delete-user-name" class="font-bold"></span>?</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Отмена</button>
                <button onclick="confirmDelete()" class="btn btn-danger">Удалить</button>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО ВЫБОРА ПОЛЬЗОВАТЕЛЯ -->
    <div id="user-select-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">👤 Выберите клиента</h3>
                <button onclick="closeUserSelectModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="user-search" placeholder="Поиск по имени или email..." 
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeyup="filterUserSelectList()">
            </div>
            
            <div id="user-select-list" class="max-h-96 overflow-y-auto space-y-2">
                <div class="text-center py-4 text-gray-500">Загрузка пользователей...</div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeUserSelectModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Отмена</button>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО КАРТОЧКИ КЛИЕНТА - ИСПРАВЛЕНО -->
<div id="client-card-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center hidden z-50 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl my-8 mx-4 relative">
        <!-- Фиксированная шапка с белым фоном и тенью -->
        <div class="sticky top-0 z-30 bg-white rounded-t-xl border-b shadow-md">
            <div class="flex justify-between items-center p-6 pt-12 pt-8">
                <h3 class="text-2xl font-bold text-gray-800" id="client-card-title">👤 Личная карточка клиента</h3>
                <button onclick="closeClientCardModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center shadow-sm">
                    <span class="mr-2">✕</span> Выход
                </button>
            </div>
                
                <!-- Вкладки карточки клиента - теперь внутри шапки -->
                <div class="border-t border-gray-200 px-6">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <li class="mr-2">
                            <button class="client-tab-btn inline-block p-4 border-b-2 border-blue-600 text-blue-600 active" id="tab-main-btn" onclick="switchClientTab('main')">
                                📋 Основное
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="client-tab-btn inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" id="tab-details-btn" onclick="switchClientTab('details')">
                                📁 Реквизиты
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="client-tab-btn inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" id="tab-projects-btn" onclick="switchClientTab('projects')">
                                📊 Проекты
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="client-tab-btn inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" id="tab-messages-btn" onclick="switchClientTab('messages')">
                                💬 Сообщения
                            </button>
                        </li>
                        <li class="mr-2">
                            <button class="client-tab-btn inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" id="tab-contracts-btn" onclick="switchClientTab('contracts')">
                                📄 Договоры
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Контент карточки с отступами -->
            <div id="client-card-content" class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="text-center py-8 text-gray-500">Загрузка данных клиента...</div>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО РЕДАКТИРОВАНИЯ РЕКВИЗИТОВ - ИСПРАВЛЕНО -->
    <div id="client-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center p-4 border-b bg-white sticky top-0 z-10 -mt-6 -mx-6 mb-6 px-6">
                <h3 class="text-2xl font-bold text-gray-800">📝 Редактирование реквизитов</h3>
                <button onclick="closeClientDetailsModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                    <span class="mr-2">✕</span> Выход
                </button>
            </div>
            
            <form id="client-details-form" onsubmit="saveClientDetails(event)">
                <input type="hidden" id="details-user-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <!-- Левая колонка -->
                    <div class="space-y-4">
                        <h4 class="font-bold text-gray-700 border-b pb-2">Юридическая информация</h4>
                        
                        <div class="form-group">
                            <label for="company-name">🏢 Название компании</label>
                            <input type="text" id="company-name" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="legal-address">📍 Юридический адрес</label>
                            <textarea id="legal-address" rows="2" class="w-full p-2 border rounded"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="actual-address">📍 Фактический адрес</label>
                            <textarea id="actual-address" rows="2" class="w-full p-2 border rounded"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-phone">📞 Контактный телефон</label>
                            <input type="text" id="contact-phone" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-email">📧 Контактный email</label>
                            <input type="email" id="contact-email" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="messenger-contact">💬 Контакт в мессенджере</label>
                            <input type="text" id="messenger-contact" class="w-full p-2 border rounded" placeholder="Telegram, WhatsApp...">
                        </div>
                        
                        <h4 class="font-bold text-gray-700 border-b pb-2 mt-4">Налоговые реквизиты</h4>
                        
                        <div class="form-group">
                            <label for="inn">🏦 ИНН</label>
                            <input type="text" id="inn" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="kpp">🏦 КПП</label>
                            <input type="text" id="kpp" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="ogrn">🏦 ОГРН</label>
                            <input type="text" id="ogrn" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    
                    <!-- Правая колонка -->
                    <div class="space-y-4">
                        <h4 class="font-bold text-gray-700 border-b pb-2">Банковские реквизиты</h4>
                        
                        <div class="form-group">
                            <label for="bank-name">💳 Банк</label>
                            <input type="text" id="bank-name" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="bik">💳 БИК</label>
                            <input type="text" id="bik" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="checking-account">💳 Расчетный счет</label>
                            <input type="text" id="checking-account" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="correspondent-account">💳 Корреспондентский счет</label>
                            <input type="text" id="correspondent-account" class="w-full p-2 border rounded">
                        </div>
                        
                        <h4 class="font-bold text-gray-700 border-b pb-2 mt-4">Руководитель</h4>
                        
                        <div class="form-group">
                            <label for="director-name">👤 ФИО руководителя</label>
                            <input type="text" id="director-name" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="form-group">
                            <label for="director-basis">📄 Действует на основании</label>
                            <input type="text" id="director-basis" class="w-full p-2 border rounded" value="Устава">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6 pt-4 border-t">
                    <button type="button" onclick="closeClientDetailsModal()" class="btn btn-secondary">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО ДОГОВОРОВ -->
    <div id="contracts-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center p-4 border-b bg-white sticky top-0 z-10 -mt-6 -mx-6 mb-6 px-6">
                <h3 class="text-2xl font-bold text-gray-800">📄 Договоры клиента</h3>
                <button onclick="closeContractsModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                    <span class="mr-2">✕</span> Выход
                </button>
            </div>
            
            <div class="mb-4 flex justify-between items-center">
                <div>
                    <span id="contracts-client-name" class="font-medium text-lg"></span>
                </div>
                <button onclick="createNewContract()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <span class="mr-2">➕</span> Новый договор
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="contracts-table">
                    <thead>
                        <tr>
                            <th class="px-4 py-3">№ договора</th>
                            <th class="px-4 py-3">Дата</th>
                            <th class="px-4 py-3">Тип</th>
                            <th class="px-4 py-3">Сумма</th>
                            <th class="px-4 py-3">Статус</th>
                            <th class="px-4 py-3">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="contracts-table-body">
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                Загрузка договоров...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО РЕДАКТИРОВАНИЯ ДОГОВОРА - ИСПРАВЛЕНО -->
    <div id="contract-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center p-4 border-b bg-white sticky top-0 z-10 -mt-6 -mx-6 mb-6 px-6">
                <h3 class="text-2xl font-bold text-gray-800">📄 Редактирование договора</h3>
                <button onclick="closeContractEditModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                    <span class="mr-2">✕</span> Выход
                </button>
            </div>
            
            <form id="contract-form" onsubmit="saveContract(event)" class="space-y-4">
                <input type="hidden" id="contract-id">
                <input type="hidden" id="contract-user-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="contract-number" class="block text-sm font-medium text-gray-700 mb-1">Номер договора</label>
                        <input type="text" id="contract-number" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="form-group">
                        <label for="contract-date" class="block text-sm font-medium text-gray-700 mb-1">Дата договора</label>
                        <input type="date" id="contract-date" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="form-group">
                        <label for="contract-type" class="block text-sm font-medium text-gray-700 mb-1">Тип договора</label>
                        <select id="contract-type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="service">На оказание услуг</option>
                            <option value="development">Разработка ПО</option>
                            <option value="nda">NDA (Соглашение о конфиденциальности)</option>
                            <option value="maintenance">Абонентское обслуживание</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contract-amount" class="block text-sm font-medium text-gray-700 mb-1">Сумма</label>
                        <input type="number" id="contract-amount" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="form-group col-span-2">
                        <label for="contract-description" class="block text-sm font-medium text-gray-700 mb-1">Описание/Предмет договора</label>
                        <textarea id="contract-description" rows="3" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="contract-status" class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
                        <select id="contract-status" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="draft">Черновик</option>
                            <option value="sent">Отправлен</option>
                            <option value="signed">Подписан</option>
                            <option value="completed">Завершён</option>
                            <option value="cancelled">Расторгнут</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contract-expiry" class="block text-sm font-medium text-gray-700 mb-1">Срок действия</label>
                        <input type="date" id="contract-expiry" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="form-group col-span-2">
                        <label for="contract-file" class="block text-sm font-medium text-gray-700 mb-1">Файл договора</label>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="contract-file" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" accept=".pdf,.doc,.docx">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Загрузите скан или электронную версию</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6 pt-4 border-t sticky bottom-0 bg-white pb-2">
                    <button type="button" onclick="closeContractEditModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="bg-gray-800 text-white p-4 mt-4">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <p>© 2024 Front end & Back end. Все права защищены.</p>
                <div class="mt-2 md:mt-0 text-sm text-gray-400">
                    <span>Версия: 2.0.0 | </span>
                    <span>Сервер: <span id="server-status" class="text-green-400">🟢 Работает</span> | </span>
                    <span>WebSocket: <span id="ws-status" class="text-yellow-500">🟡 Подключение...</span></span>
                </div>
            </div>
        </div>
    </footer>
    
    <script>
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let adminWebSocket = null;
        let activeChatUser = null;
        let lastMessageId = null;
        let reconnectAttempts = 0;
        let editMode = false;
        let editingMessageDiv = null;
        let editingContentDiv = null;
        let originalMessageContent = '';
        const MAX_RECONNECT_ATTEMPTS = 10;
        let currentUsers = [];
        let userToDelete = null;
        let currentContractsUserId = null;
        let currentContractsUserName = '';
        let currentClientId = null;
        let currentClientName = '';
        let currentClientEmail = '';
        let clientCardRefreshInterval = null;
        let currentProjects = [];

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('%c🔍 АДМИН-ПАНЕЛЬ: ИНИЦИАЛИЗАЦИЯ', 'background: #2563eb; color: white; font-size: 14px; padding: 4px;');
            
            const token = localStorage.getItem('access_token');
            const userId = localStorage.getItem('user_id');
            
            if (!token) {
                console.error('%c❌ ТОКЕН ОТСУТСТВУЕТ', 'background: #dc2626; color: white;');
                showNotification('❌ Ошибка авторизации', 'error');
                setTimeout(() => { window.location.href = '/login'; }, 2000);
                return;
            }
            
            if (!userId || userId !== '1') {
                console.error('%c❌ НЕ АДМИНИСТРАТОР', 'background: #dc2626; color: white;');
                showNotification('⛔ Доступ запрещён', 'error');
                setTimeout(() => { window.location.href = '/dashboard'; }, 2000);
                return;
            }
            
            fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .then(data => {
                if (!data.is_admin) {
                    throw new Error('Не администратор');
                }
                initializeAdminPanel();
            })
            .catch(error => {
                console.error('❌ Ошибка валидации:', error);
                showNotification('❌ Ошибка авторизации', 'error');
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_name');
                setTimeout(() => { window.location.href = '/login'; }, 2000);
            });
        });

        function initializeAdminPanel() {
            console.log('%c🚀 ЗАПУСК АДМИН-ПАНЕЛИ', 'background: #2563eb; color: white;');
            loadTab('users');
            updateAdminEmail();
            loadQuickStats();
            connectAdminWebSocket();
            logToConsole('✅ Админ-панель успешно инициализирована');
            logToConsole('👤 Администратор: ' + localStorage.getItem('user_email'));
            showNotification('✅ Админ-панель загружена', 'success');
        }

        function updateAdminEmail() {
            const adminEmail = localStorage.getItem('user_email');
            const emailElement = document.getElementById('admin-email');
            if (emailElement) {
                emailElement.textContent = adminEmail || 't72trak@gmail.com';
            }
        }

        function logout() {
            console.log('🚪 Выход из системы');
            if (adminWebSocket) {
                adminWebSocket.close();
            }
            if (clientCardRefreshInterval) {
                clearInterval(clientCardRefreshInterval);
            }
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_name');
            window.location.href = '/login';
        }

        async function loadQuickStats() {
            console.log('📊 Загрузка быстрой статистики...');
            try {
                const token = localStorage.getItem('access_token');
                try {
                    const response = await fetch('/api/admin/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('stats-users').textContent = data.users || 0;
                        document.getElementById('stats-projects').textContent = data.projects || 0;
                        document.getElementById('stats-services').textContent = data.services || 0;
                        document.getElementById('stats-messages').textContent = data.messages || 0;
                        document.getElementById('stats-transactions').textContent = data.transactions || 0;
                        logToConsole(`📊 Статистика: ${data.users} пользователей, ${data.projects} проектов, ${data.services} услуг, ${data.messages} сообщений`);
                        return;
                    }
                } catch(e) { 
                    console.log('API статистики недоступно, используем локальные данные');
                }
                
                try {
                    const usersRes = await fetch('/api/admin/users', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (usersRes.ok) {
                        const usersData = await usersRes.json();
                        document.getElementById('stats-users').textContent = usersData.count || 0;
                    }
                } catch(e) { console.log('Ошибка загрузки пользователей:', e); }
                
                try {
                    const messagesRes = await fetch('/api/chat/stats/total');
                    if (messagesRes.ok) {
                        const messagesData = await messagesRes.json();
                        document.getElementById('stats-messages').textContent = messagesData.total || 0;
                    }
                } catch(e) { console.log('Ошибка загрузки сообщений:', e); }
                
            } catch (error) {
                console.error('❌ Ошибка загрузки статистики:', error);
                logToConsole('❌ Ошибка загрузки статистики');
            }
        }

        function updateMessageStats() {
            const statsMessages = document.getElementById('stats-messages');
            if (statsMessages) {
                let currentCount = parseInt(statsMessages.textContent) || 0;
                statsMessages.textContent = currentCount + 1;
                statsMessages.classList.add('stat-highlight');
                setTimeout(() => {
                    statsMessages.classList.remove('stat-highlight');
                }, 500);
            }
            setTimeout(() => {
                loadQuickStats();
            }, 500);
            if (currentClientId && !document.getElementById('client-card-modal').classList.contains('hidden')) {
                loadClientCardData(currentClientId, currentClientName, currentClientEmail);
            }
        }

        function switchClientTab(tabName) {
            document.querySelectorAll('.client-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent');
            });
            document.getElementById(`tab-${tabName}-btn`).classList.add('active', 'border-blue-600', 'text-blue-600');
            document.querySelectorAll('.client-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`client-tab-${tabName}`)?.classList.add('active');
        }

        async function loadTab(tabName) {
            console.log('📁 Загрузка вкладки:', tabName);
            logToConsole(`📁 Загрузка раздела "${tabName}"...`);
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
            });
            
            const currentTab = document.getElementById('tab-' + tabName);
            if (currentTab) {
                currentTab.classList.add('active-tab');
            }
            
            document.getElementById('content-area').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600">Загрузка раздела "${tabName}"...</p>
                </div>
            `;
            
            try {
                const token = localStorage.getItem('access_token');
                
                switch(tabName) {
                    case 'users':
                        await loadUsersTab(token);
                        break;
                    case 'payments':
                        await loadPaymentsTab(token);
                        break;
                    case 'projects':
                        await loadProjectsTab(token);
                        break;
                    case 'work-materials':
                        await loadWorkMaterialsTab(token);
                        break;
                    case 'archive':
                        await loadArchiveTab(token);
                        break;
                    case 'contracts':
                        await loadContractsTab(token);
                        break;
                    default:
                        document.getElementById('content-area').innerHTML = '<p class="text-red-500">Неизвестная вкладка</p>';
                }
                
                logToConsole(`✅ Вкладка "${tabName}" загружена`);
                
            } catch (error) {
                console.error('❌ Ошибка загрузки вкладки:', error);
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-red-800 font-bold text-lg mb-2">⚠️ Ошибка загрузки</h3>
                        <p class="text-red-600 mb-4">Не удалось загрузить раздел "${tabName}"</p>
                        <div class="bg-red-100 p-3 rounded text-sm text-red-800 mb-4">
                            <strong>Детали:</strong> ${error.message}
                        </div>
                        <button onclick="loadTab('${tabName}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                            Попробовать снова
                        </button>
                    </div>
                `;
                logToConsole(`❌ Ошибка загрузки "${tabName}": ${error.message}`);
            }
        }

        // ========== РАЗДЕЛ ПОЛЬЗОВАТЕЛЕЙ ==========
        async function loadUsersTab(token) {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                currentUsers = data.users || [];
                
                let tableRows = '';
                
                if (currentUsers.length === 0) {
                    tableRows = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                Нет пользователей
                            </td>
                        </tr>
                    `;
                } else {
                    currentUsers.forEach(user => {
                        const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Н/Д';
                        const roleBadge = user.is_admin 
                            ? '<span class="badge admin">Администратор</span>' 
                            : '<span class="badge user">Пользователь</span>';
                        
                        tableRows += `
                            <tr>
                                <td class="px-4 py-3 text-black">${user.id}</td>
                                <td class="px-4 py-3 font-medium text-black">${user.name || 'Без имени'}</td>
                                <td class="px-4 py-3 text-black">${user.email}</td>
                                <td class="px-4 py-3">${roleBadge}</td>
                                <td class="px-4 py-3 text-black">${createdDate}</td>
                                <td class="px-4 py-3">
                                    <button onclick="editUser(${user.id})" class="action-btn edit" title="Редактировать">
                                        ✏️
                                    </button>
                                    <button onclick="deleteUser(${user.id})" class="action-btn delete" title="Удалить">
                                        🗑️
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                const content = `
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-black text-center mb-8">Панель управления пользователями</h2>
                        
                        <div class="flex justify-center items-center space-x-6 mb-8">
                            <div class="relative">
                                <button onclick="toggleUserListDropdown()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                    <span class="mr-2">📋</span> Список пользователей
                                </button>
                                <div id="user-list-dropdown" class="user-list-dropdown hidden">
                                    <div class="p-2 text-gray-500 text-center">Загрузка...</div>
                                </div>
                            </div>
                            
                            <button onclick="openUserSelectModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                <span class="mr-2">🆔</span> Личная карточка клиента
                            </button>
                            
                            <button onclick="showAddUserModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                <span class="mr-2">➕</span> Добавить пользователя
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full data-table">
                                <thead>
                                    <tr>
                                        <th class="text-black">ID</th>
                                        <th class="text-black">Имя</th>
                                        <th class="text-black">Email</th>
                                        <th class="text-black">Роль</th>
                                        <th class="text-black">Дата регистрации</th>
                                        <th class="text-black">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
                loadUserListDropdownContent();
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-red-800 font-bold text-lg mb-2">⚠️ Ошибка загрузки пользователей</h3>
                        <p class="text-red-600 mb-4">${error.message}</p>
                        <button onclick="loadUsersTab('${token}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                            Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        function toggleUserListDropdown() {
            const dropdown = document.getElementById('user-list-dropdown');
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        async function loadUserListDropdownContent() {
            const dropdown = document.getElementById('user-list-dropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<div class="p-2 text-gray-500 text-center">Загрузка...</div>';
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const users = data.users || [];
                
                if (users.length === 0) {
                    dropdown.innerHTML = '<div class="p-2 text-gray-500 text-center">Нет пользователей</div>';
                    return;
                }
                
                let html = '';
                users.forEach(user => {
                    html += `
                        <div onclick="selectUserFromList(${user.id})" class="user-list-item">
                            <div class="name">${user.name || 'Без имени'}</div>
                            <div class="email">${user.email}</div>
                        </div>
                    `;
                });
                
                dropdown.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки списка пользователей:', error);
                dropdown.innerHTML = '<div class="p-2 text-red-500 text-center">Ошибка загрузки</div>';
            }
        }

        function selectUserFromList(userId) {
            document.getElementById('user-list-dropdown').classList.add('hidden');
            const user = currentUsers.find(u => u.id === userId);
            if (user) {
                selectUserForClientCard(user.id, user.name || 'Без имени', user.email);
            }
        }

        function showAddUserModal() {
            document.getElementById('modal-title').textContent = 'Добавить пользователя';
            document.getElementById('user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = true;
            document.getElementById('user-is-admin').value = 'false';
            document.getElementById('user-modal').classList.add('active');
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modal-title').textContent = 'Редактировать пользователя';
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = false;
            document.getElementById('user-is-admin').value = user.is_admin ? 'true' : 'false';
            document.getElementById('user-modal').classList.add('active');
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const isAdmin = document.getElementById('user-is-admin').value === 'true';
            
            const token = localStorage.getItem('access_token');
            
            try {
                let response;
                
                if (userId) {
                    response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name: name,
                            email: email,
                            password: password || undefined,
                            is_admin: isAdmin
                        })
                    });
                } else {
                    response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            email: email,
                            password: password
                        })
                    });
                }
                
                if (response.ok) {
                    showNotification(userId ? '✅ Пользователь обновлён' : '✅ Пользователь создан', 'success');
                    closeModal();
                    loadUsersTab(token);
                    loadQuickStats();
                } else {
                    const error = await response.json();
                    showNotification('❌ Ошибка: ' + (error.detail || 'Неизвестная ошибка'), 'error');
                }
                
            } catch (error) {
                console.error('Ошибка сохранения пользователя:', error);
                showNotification('❌ Ошибка при сохранении', 'error');
            }
        }

        function deleteUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;
            
            userToDelete = userId;
            document.getElementById('delete-user-name').textContent = user.name || user.email;
            document.getElementById('delete-modal').classList.add('active');
        }

        function confirmDelete() {
            if (!userToDelete) return;
            
            const token = localStorage.getItem('access_token');
            
            fetch(`/api/admin/users/${userToDelete}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => {
                if (response.ok) {
                    showNotification('✅ Пользователь удалён', 'success');
                    closeDeleteModal();
                    loadUsersTab(token);
                    loadQuickStats();
                } else {
                    showNotification('❌ Ошибка при удалении', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка удаления:', error);
                showNotification('❌ Ошибка при удалении', 'error');
            });
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            userToDelete = null;
        }

        // ========== ФУНКЦИИ ДЛЯ ЧАТА ==========
        function loadUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            if (!dropdown) return;
            dropdown.classList.remove('hidden');
            
            const token = localStorage.getItem('access_token');
            
            fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const users = data.users || [];
                    if (users.length === 0) {
                        dropdown.innerHTML = '<div class="p-2 text-gray-500 text-center">Нет пользователей</div>';
                        return;
                    }
                    let html = '';
                    users.forEach(user => {
                        const userName = user.name || user.email || 'Пользователь';
                        const safeName = userName.replace(/'/g, "\\'");
                        const safeEmail = user.email.replace(/'/g, "\\'");
                        html += 
                            '<div class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 user-item"' +
                            '     data-user-id="' + user.id + '"' +
                            '     data-user-name="' + userName + '"' +
                            '     data-user-email="' + user.email + '"' +
                            '     onclick="selectUserForChat(' + user.id + ', \'' + safeName + '\', \'' + safeEmail + '\')">' +
                            '    <div class="font-medium">' + userName + '</div>' +
                            '    <div class="text-xs text-gray-500">' + user.email + '</div>' +
                            '</div>';
                    });
                    dropdown.innerHTML = html;
                    logToConsole('👥 Загружено пользователей: ' + users.length);
                })
                .catch(error => {
                    console.error('Ошибка загрузки пользователей:', error);
                    dropdown.innerHTML = '<div class="p-2 text-red-500 text-center">Ошибка загрузки</div>';
                    logToConsole('❌ Ошибка загрузки пользователей');
                });
        }

        function filterUsers() {
            const searchInput = document.getElementById('chat-search').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                const name = item.getAttribute('data-user-name').toLowerCase();
                const email = item.getAttribute('data-user-email').toLowerCase();
                if (name.includes(searchInput) || email.includes(searchInput)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectUserForChat(userId, userName, userEmail) {
            document.getElementById('chat-search').value = userName;
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
            
            activeChatUser = {
                id: userId,
                name: userName,
                email: userEmail
            };
            
            loadChatHistory(userId);
            logToConsole('💬 Выбран пользователь: ' + userName);
        }

        function loadChatHistory(userId) {
            const messagesContainer = document.getElementById('chat-messages-container');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600">Загрузка истории сообщений...</p>
                </div>
            `;
            
            fetch('/api/chat/history/' + userId, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(messages => {
                    let html = '';
                    if (messages.length === 0) {
                        html = `
                            <div class="text-center py-8 text-gray-400">
                                <div class="text-3xl mb-2">💬</div>
                                <p>История сообщений пуста</p>
                                <p class="text-sm mt-2">Начните диалог первым сообщением</p>
                            </div>
                        `;
                    } else {
                        messages.forEach(msg => {
                            const isAdmin = msg.sender_id === 1;
                            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const bubbleClass = isAdmin ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800';
                            const align = isAdmin ? 'justify-end' : 'justify-start';
                            
                            html += `
                                <div class="flex ${align} mb-3">
                                    <div class="max-w-xs md:max-w-md lg:max-w-lg ${bubbleClass} rounded-lg p-3">
                                        <div class="message-content">${msg.content}</div>
                                        <div class="text-xs opacity-70 mt-1 text-right">${time}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    messagesContainer.innerHTML = html;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    logToConsole(`💬 Загружено сообщений: ${messages.length}`);
                })
                .catch(error => {
                    console.error('Ошибка загрузки истории:', error);
                    messagesContainer.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <p class="text-red-600 font-medium">❌ Ошибка загрузки истории сообщений</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        </div>
                    `;
                    logToConsole('❌ Ошибка загрузки истории чата');
                });
        }

        function sendAdminMessage() {
            if (!activeChatUser) {
                alert('Выберите пользователя для отправки сообщения');
                return;
            }
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            if (adminWebSocket && adminWebSocket.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'admin_message',
                    user_id: activeChatUser.id,
                    content: message,
                    timestamp: new Date().toISOString()
                };
                
                adminWebSocket.send(JSON.stringify(messageData));
                
                const messagesContainer = document.getElementById('chat-messages-container');
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-end mb-3';
                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg bg-blue-100 text-blue-800 rounded-lg p-3">
                        <div class="message-content">${message}</div>
                        <div class="text-xs opacity-70 mt-1 text-right">${time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                input.value = '';
                logToConsole('📤 Отправлено сообщение пользователю ' + activeChatUser.name);
                
                updateMessageStats();
                
                if (currentClientId && !document.getElementById('client-card-modal').classList.contains('hidden')) {
                    loadClientCardData(currentClientId, currentClientName, currentClientEmail);
                }
            } else {
                alert('WebSocket не подключен. Перезагрузите страницу.');
                logToConsole('❌ WebSocket не подключен');
                connectAdminWebSocket();
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }

        function refreshChatList() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                loadUserDropdown();
            }
            logToConsole('🔄 Список пользователей обновлен');
        }

        function connectAdminWebSocket() {
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                console.error('❌ Нет User ID для WebSocket');
                return;
            }
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = wsProtocol + '//' + window.location.host + '/api/chat/ws/chat/0';
            
            console.log('🔌 Подключение к WebSocket:', wsUrl);
            logToConsole('🔌 Подключение к WebSocket...');
            
            try {
                adminWebSocket = new WebSocket(wsUrl);
                
                adminWebSocket.onopen = function() {
                    console.log('✅ WebSocket подключен (админ)');
                    logToConsole('✅ WebSocket подключен');
                    
                    const wsStatus = document.getElementById('ws-status');
                    if (wsStatus) {
                        wsStatus.innerHTML = '🟢 Подключен';
                        wsStatus.className = 'text-green-400';
                    }
                    
                    reconnectAttempts = 0;
                };
                
                adminWebSocket.onclose = function(event) {
                    console.log('❌ WebSocket отключен:', event.code, event.reason);
                    logToConsole('❌ WebSocket отключен');
                    
                    const wsStatus = document.getElementById('ws-status');
                    if (wsStatus) {
                        wsStatus.innerHTML = '🔴 Отключен';
                        wsStatus.className = 'text-red-400';
                    }
                    
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 10000);
                        console.log(`🔄 Переподключение через ${delay/1000}с... (попытка ${reconnectAttempts})`);
                        logToConsole(`🔄 Переподключение через ${delay/1000}с...`);
                        setTimeout(connectAdminWebSocket, delay);
                    }
                };
                
                adminWebSocket.onerror = function(error) {
                    console.error('⚠️ Ошибка WebSocket:', error);
                    logToConsole('⚠️ Ошибка WebSocket');
                };
                
                adminWebSocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'new_message') {
                            if (activeChatUser && activeChatUser.id === data.user_id) {
                                const messagesContainer = document.getElementById('chat-messages-container');
                                const time = new Date(data.timestamp || data.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                
                                const messageDiv = document.createElement('div');
                                messageDiv.className = 'flex justify-start mb-3';
                                messageDiv.innerHTML = `
                                    <div class="max-w-xs md:max-w-md lg:max-w-lg bg-gray-200 text-gray-800 rounded-lg p-3">
                                        <div class="message-content">${data.content}</div>
                                        <div class="text-xs opacity-70 mt-1 text-right">${time}</div>
                                    </div>
                                `;
                                
                                messagesContainer.appendChild(messageDiv);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                logToConsole('📩 Новое сообщение от ' + activeChatUser.name);
                                showNotification(`Новое сообщение от ${activeChatUser.name}`, 'info');
                                
                                updateMessageStats();
                                
                                if (currentClientId && currentClientId === data.user_id && !document.getElementById('client-card-modal').classList.contains('hidden')) {
                                    loadClientCardData(currentClientId, currentClientName, currentClientEmail);
                                }
                            } else {
                                updateMessageStats();
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка обработки сообщения:', error);
                    }
                };
            } catch (error) {
                console.error('❌ Ошибка создания WebSocket:', error);
                logToConsole('❌ Ошибка создания WebSocket');
            }
        }

        // ========== РЕДАКТИРОВАНИЕ СООБЩЕНИЙ ==========
        function editLastMessage() {
            if (!activeChatUser) {
                showNotification('Сначала выберите пользователя в чате', 'warning');
                return;
            }
            
            if (editMode) {
                cancelEdit();
                return;
            }
            
            const messagesContainer = document.getElementById('chat-messages-container');
            const adminMessages = messagesContainer.querySelectorAll('.bg-blue-100');
            
            if (adminMessages.length === 0) {
                showNotification('Нет сообщений для редактирования', 'warning');
                return;
            }
            
            editingMessageDiv = adminMessages[adminMessages.length - 1];
            editingContentDiv = editingMessageDiv.querySelector('.message-content');
            
            if (!editingContentDiv) return;
            
            originalMessageContent = editingContentDiv.textContent;
            editMode = true;
            
            editingMessageDiv.classList.add('message-edit-mode');
            
            const editTextarea = document.createElement('textarea');
            editTextarea.value = originalMessageContent;
            editTextarea.className = 'edit-textarea';
            editTextarea.rows = 3;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'edit-buttons';
            buttonContainer.innerHTML = `
                <button onclick="saveEdit()" class="edit-save-btn">✅ Сохранить</button>
                <button onclick="cancelEdit()" class="edit-cancel-btn">❌ Отмена</button>
            `;
            
            editingContentDiv.innerHTML = '';
            editingContentDiv.appendChild(editTextarea);
            editingContentDiv.appendChild(buttonContainer);
            
            editTextarea.focus();
            
            const editButton = document.querySelector('button[onclick="editLastMessage()"]');
            editButton.innerHTML = '❌ Отмена';
            
            showNotification('Редактирование сообщения. Нажмите "Сохранить" для подтверждения.', 'info');
            logToConsole('✏️ Режим редактирования активирован');
        }

        function saveEdit() {
            if (!editingContentDiv) return;
            
            const textarea = editingContentDiv.querySelector('textarea');
            if (!textarea) return;
            
            const newMessage = textarea.value.trim();
            
            if (!newMessage) {
                showNotification('Сообщение не может быть пустым', 'error');
                return;
            }
            
            const oldMessage = originalMessageContent;
            editingContentDiv.innerHTML = newMessage;
            
            if (editingMessageDiv) {
                editingMessageDiv.classList.remove('message-edit-mode');
            }
            
            if (adminWebSocket && adminWebSocket.readyState === WebSocket.OPEN) {
                const editData = {
                    type: 'edit_message',
                    user_id: activeChatUser.id,
                    old_content: oldMessage,
                    new_content: newMessage,
                    timestamp: new Date().toISOString()
                };
                adminWebSocket.send(JSON.stringify(editData));
            }
            
            exitEditMode();
            
            showNotification('✅ Сообщение исправлено', 'success');
            logToConsole('✅ Сообщение исправлено: "' + oldMessage + '" -> "' + newMessage + '"');
        }

        function cancelEdit() {
            if (!editingContentDiv || !editingMessageDiv) return;
            
            editingContentDiv.innerHTML = originalMessageContent;
            editingMessageDiv.classList.remove('message-edit-mode');
            
            exitEditMode();
            
            showNotification('Редактирование отменено', 'info');
            logToConsole('✏️ Редактирование отменено');
        }

        function exitEditMode() {
            editMode = false;
            editingMessageDiv = null;
            editingContentDiv = null;
            originalMessageContent = '';
            
            const editButton = document.querySelector('button[onclick="editLastMessage()"]');
            editButton.innerHTML = '✏️ Редактировать сообщение';
        }

        // ========== ФУНКЦИИ ДЛЯ ПАНЕЛИ РАЗРАБОТЧИКА ==========
        function logToConsole(message) {
            const consoleEl = document.getElementById('dev-console');
            if (!consoleEl) return;
            
            const timestamp = new Date().toLocaleTimeString();
            consoleEl.innerHTML += '<div>> [' + timestamp + '] ' + message + '</div>';
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function testWebSocket() {
            if (adminWebSocket && adminWebSocket.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'admin_message',
                    user_id: activeChatUser ? activeChatUser.id : 2,
                    content: '🧪 Тестовое сообщение от администратора',
                    timestamp: new Date().toISOString()
                };
                adminWebSocket.send(JSON.stringify(testMessage));
                logToConsole('🧪 Тестовое сообщение отправлено');
                showNotification('Тест WebSocket выполнен', 'success');
                
                updateMessageStats();
            } else {
                logToConsole('⚠️ WebSocket не подключен');
                showNotification('WebSocket не подключен', 'error');
                connectAdminWebSocket();
            }
        }

        function clearCache() {
            const token = localStorage.getItem('access_token');
            const userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            const userName = localStorage.getItem('user_name');
            
            sessionStorage.clear();
            
            localStorage.setItem('access_token', token);
            localStorage.setItem('user_id', userId);
            localStorage.setItem('user_email', userEmail);
            localStorage.setItem('user_name', userName);
            
            logToConsole('🧹 Кэш очищен');
            showNotification('Кэш очищен', 'success');
        }

        function reloadData() {
            loadQuickStats();
            logToConsole('🔄 Данные обновлены');
            showNotification('Данные обновлены', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': 'bg-green-100 border-green-400 text-green-700',
                'error': 'bg-red-100 border-red-400 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700',
                'info': 'bg-blue-100 border-blue-400 text-blue-700'
            };
            
            notification.className = 'notification fixed top-4 right-4 p-4 rounded-lg border-l-4 ' + colors[type] + ' shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                    </div>
                    <div class="ml-3">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto pl-3">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ========== ФУНКЦИИ ДЛЯ ЛИЧНОЙ КАРТОЧКИ КЛИЕНТА ==========
        
        function openUserSelectModal() {
            const modal = document.getElementById('user-select-modal');
            if (modal) {
                modal.classList.remove('hidden');
                loadUserSelectList();
            }
        }

        function closeUserSelectModal() {
            const modal = document.getElementById('user-select-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function loadUserSelectList() {
            const listContainer = document.getElementById('user-select-list');
            if (!listContainer) return;
            
            listContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Загрузка пользователей...</div>';
            
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Ошибка загрузки пользователей');
                
                const data = await response.json();
                const users = data.users || [];
                
                if (users.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Нет зарегистрированных пользователей</div>';
                    return;
                }
                
                let html = '';
                users.forEach(user => {
                    const safeName = (user.name || 'Без имени').replace(/'/g, "\\'");
                    const safeEmail = user.email.replace(/'/g, "\\'");
                    html += `
                        <div class="p-3 border rounded-lg hover:bg-gray-50 cursor-pointer transition"
                             onclick="selectUserForClientCard(${user.id}, '${safeName}', '${safeEmail}')">
                            <div class="font-medium text-gray-800">${user.name || 'Без имени'}</div>
                            <div class="text-sm text-gray-600">${user.email}</div>
                            <div class="text-xs mt-1">
                                <span class="px-2 py-1 rounded-full ${user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">
                                    ${user.is_admin ? 'Администратор' : 'Пользователь'}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                listContainer.innerHTML = '<div class="text-center py-4 text-red-500">Ошибка загрузки. Попробуйте позже.</div>';
            }
        }

        function filterUserSelectList() {
            const searchText = document.getElementById('user-search')?.value.toLowerCase() || '';
            const items = document.querySelectorAll('#user-select-list > div');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function selectUserForClientCard(userId, userName, userEmail) {
            closeUserSelectModal();
            
            currentClientId = userId;
            currentClientName = userName;
            currentClientEmail = userEmail;
            
            const modal = document.getElementById('client-card-modal');
            const content = document.getElementById('client-card-content');
            
            if (modal && content) {
                modal.classList.remove('hidden');
                content.innerHTML = '<div class="text-center py-8 text-gray-500">Загрузка данных клиента...</div>';
                
                document.querySelectorAll('.client-tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                    btn.classList.add('border-transparent');
                });
                document.getElementById('tab-main-btn').classList.add('active', 'border-blue-600', 'text-blue-600');
                
                await loadClientCardData(userId, userName, userEmail);
            }
        }

        async function loadClientCardData(userId, userName, userEmail) {
            const content = document.getElementById('client-card-content');
            if (!content) return;
            
            try {
                const token = localStorage.getItem('access_token');
                
                let clientDetails = {};
                try {
                    const detailsResponse = await fetch(`/api/admin/clients/${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (detailsResponse.ok) {
                        clientDetails = await detailsResponse.json();
                    }
                } catch (e) {
                    console.log('Реквизиты не найдены, будут пустые');
                }
                
                let statistics = {
                    total_messages: 0,
                    total_projects: 0,
                    total_transactions: 0,
                    total_payments_sum: 0
                };
                try {
                    const statsResponse = await fetch(`/api/admin/clients/${userId}/statistics`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (statsResponse.ok) {
                        statistics = await statsResponse.json();
                        console.log('📊 Статистика загружена:', statistics);
                    }
                } catch (e) {
                    console.log('Статистика не загружена');
                }
                
                let messages = [];
                try {
                    const messagesResponse = await fetch(`/api/chat/history/${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (messagesResponse.ok) {
                        messages = await messagesResponse.json();
                        console.log('💬 Сообщений загружено:', messages.length);
                        if (statistics.total_messages !== messages.length) {
                            statistics.total_messages = messages.length;
                        }
                    }
                } catch (e) {
                    console.log('Сообщения не загружены');
                }
                
                let projects = [];
                try {
                    const projectsResponse = await fetch(`/api/admin/projects?user_id=${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (projectsResponse.ok) {
                        const projectsData = await projectsResponse.json();
                        projects = projectsData.projects || [];
                    }
                } catch (e) {
                    console.log('Проекты не загружены');
                }
                
                const messagesHtml = messages.slice(0, 5).map(msg => {
                    const time = new Date(msg.created_at).toLocaleString('ru-RU', {
                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                    });
                    const sender = msg.sender_id == userId ? '👤 Клиент' : '👨‍💼 Админ';
                    return `
                        <div class="p-2 bg-white rounded border text-sm">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>${time}</span>
                                <span>${sender}</span>
                            </div>
                            <div class="text-black">${msg.content}</div>
                        </div>
                    `;
                }).join('');
                
                const projectsHtml = projects.slice(0, 3).map(project => {
                    const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'in_progress': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-red-100 text-red-800'
                    };
                    const statusClass = statusColors[project.status] || 'bg-gray-100 text-gray-800';
                    const statusText = {
                        'pending': 'Ожидает',
                        'in_progress': 'В работе',
                        'completed': 'Завершён',
                        'cancelled': 'Отменён'
                    }[project.status] || project.status;
                    
                    return `
                        <div class="p-2 bg-white rounded border flex justify-between items-center">
                            <div>
                                <div class="font-medium text-black">${project.title}</div>
                                <div class="text-xs text-gray-600">${project.description || ''}</div>
                            </div>
                            <span class="px-2 py-1 ${statusClass} rounded-full text-xs">${statusText}</span>
                        </div>
                    `;
                }).join('');
                
                const detailsHtml = `
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-600">🏢 Компания:</span> <span class="font-medium text-black ml-2">${clientDetails.company_name || '—'}</span></div>
                        <div><span class="text-gray-600">📍 Юр. адрес:</span> <span class="font-medium text-black ml-2">${clientDetails.legal_address || '—'}</span></div>
                        <div><span class="text-gray-600">📍 Факт. адрес:</span> <span class="font-medium text-black ml-2">${clientDetails.actual_address || '—'}</span></div>
                        <div><span class="text-gray-600">📞 Телефон:</span> <span class="font-medium text-black ml-2">${clientDetails.contact_phone || '—'}</span></div>
                        <div><span class="text-gray-600">📧 Email:</span> <span class="font-medium text-black ml-2">${clientDetails.contact_email || '—'}</span></div>
                        <div><span class="text-gray-600">💬 Мессенджер:</span> <span class="font-medium text-black ml-2">${clientDetails.messenger_contact || '—'}</span></div>
                        <div><span class="text-gray-600">🏦 ИНН:</span> <span class="font-medium text-black ml-2">${clientDetails.inn || '—'}</span></div>
                        <div><span class="text-gray-600">🏦 КПП:</span> <span class="font-medium text-black ml-2">${clientDetails.kpp || '—'}</span></div>
                        <div><span class="text-gray-600">🏦 ОГРН:</span> <span class="font-medium text-black ml-2">${clientDetails.ogrn || '—'}</span></div>
                        <div><span class="text-gray-600">💳 Банк:</span> <span class="font-medium text-black ml-2">${clientDetails.bank_name || '—'}</span></div>
                        <div><span class="text-gray-600">💳 БИК:</span> <span class="font-medium text-black ml-2">${clientDetails.bik || '—'}</span></div>
                        <div><span class="text-gray-600">💳 Р/С:</span> <span class="font-medium text-black ml-2">${clientDetails.checking_account || '—'}</span></div>
                        <div><span class="text-gray-600">💳 К/С:</span> <span class="font-medium text-black ml-2">${clientDetails.correspondent_account || '—'}</span></div>
                        <div><span class="text-gray-600">👤 Руководитель:</span> <span class="font-medium text-black ml-2">${clientDetails.director_name || '—'}</span></div>
                        <div><span class="text-gray-600">📄 Основание:</span> <span class="font-medium text-black ml-2">${clientDetails.director_basis || '—'}</span></div>
                    </div>
                `;
                
                const mainTabHtml = `
                    <div class="grid grid-cols-3 gap-6">
                        <div class="col-span-1 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-700 mb-3">👤 Основная информация</h4>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-600">🆔 ID:</span> <span class="font-medium text-black">${userId}</span></div>
                                    <div><span class="text-gray-600">👤 Имя:</span> <span class="font-medium text-black">${userName}</span></div>
                                    <div><span class="text-gray-600">📧 Email:</span> <span class="font-medium text-black">${userEmail}</span></div>
                                    <div><span class="text-gray-600">📅 Регистрация:</span> <span class="font-medium text-black">${new Date().toLocaleDateString()}</span></div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-700 mb-3">📊 Статистика</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">💬 Сообщений:</span>
                                        <span class="font-medium text-black">${statistics.total_messages}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">📁 Проектов:</span>
                                        <span class="font-medium text-black">${statistics.total_projects}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">💰 Транзакций:</span>
                                        <span class="font-medium text-black">${statistics.total_transactions}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">💳 Сумма:</span>
                                        <span class="font-medium text-black">${statistics.total_payments_sum.toLocaleString()} ₽</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-2">
                                <button onclick="openClientDetailsModal(${userId})" 
                                        class="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center">
                                    <span class="mr-2">📝</span> Реквизиты
                                </button>
                                <button onclick="editUser(${userId})" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center">
                                    <span class="mr-2">✏️</span> Редактировать
                                </button>
                                <button onclick="openChatWithUser(${userId}, '${userName.replace(/'/g, "\\'")}')" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center">
                                    <span class="mr-2">💬</span> Написать
                                </button>
                                <button onclick="openContractsModal(${userId}, '${userName.replace(/'/g, "\\'")}')" 
                                        class="w-full bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center">
                                    <span class="mr-2">📄</span> Договора
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-span-2 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-gray-700">💬 Последние сообщения</h4>
                                    <button onclick="switchToChat('${userName.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline">
                                        Все сообщения →
                                    </button>
                                </div>
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${messagesHtml || '<div class="text-gray-500 text-sm">Нет сообщений</div>'}
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-gray-700">📁 Проекты клиента</h4>
                                    <button onclick="switchToProjects('${userName.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline">
                                        Все проекты →
                                    </button>
                                </div>
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${projectsHtml || '<div class="text-gray-500 text-sm">Нет проектов</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = `
                    <div id="client-tab-main" class="client-tab-content active">${mainTabHtml}</div>
                    <div id="client-tab-details" class="client-tab-content">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-gray-700">📁 Реквизиты клиента</h4>
                                <button onclick="openClientDetailsModal(${userId})" class="text-sm text-blue-600 hover:underline">
                                    Редактировать →
                                </button>
                            </div>
                            ${detailsHtml}
                        </div>
                    </div>
                    <div id="client-tab-projects" class="client-tab-content">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-gray-700">📁 Проекты клиента</h4>
                                <button onclick="switchToProjects('${userName.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline">
                                    Управление проектами →
                                </button>
                            </div>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${projectsHtml || '<div class="text-gray-500 text-sm">Нет проектов</div>'}
                            </div>
                        </div>
                    </div>
                    <div id="client-tab-messages" class="client-tab-content">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-gray-700">💬 История сообщений</h4>
                                <button onclick="switchToChat('${userName.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline">
                                    Перейти в чат →
                                </button>
                            </div>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${messages.map(msg => {
                                    const time = new Date(msg.created_at).toLocaleString('ru-RU', {
                                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                                    });
                                    const sender = msg.sender_id == userId ? '👤 Клиент' : '👨‍💼 Админ';
                                    const bgClass = msg.sender_id == userId ? 'bg-white' : 'bg-blue-50';
                                    return `
                                        <div class="p-3 ${bgClass} rounded border text-sm">
                                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                                <span>${time}</span>
                                                <span>${sender}</span>
                                            </div>
                                            <div class="text-black">${msg.content}</div>
                                        </div>
                                    `;
                                }).join('') || '<div class="text-gray-500 text-sm">Нет сообщений</div>'}
                            </div>
                        </div>
                    </div>
                    <div id="client-tab-contracts" class="client-tab-content">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-gray-700">📄 Договоры клиента</h4>
                                <button onclick="openContractsModal(${userId}, '${userName.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline">
                                    Управление договорами →
                                </button>
                            </div>
                            <div class="text-center py-8 text-gray-500">
                                <svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>Для просмотра и создания договоров</p>
                                <p class="text-sm mt-2">нажмите кнопку "Управление договорами"</p>
                            </div>
                        </div>
                    </div>
                `;
                
                showNotification('✅ Данные клиента загружены', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки данных клиента:', error);
                content.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки данных. Попробуйте позже.</div>';
            }
        }

        function closeClientCardModal() {
            const modal = document.getElementById('client-card-modal');
            if (modal) {
                modal.classList.add('hidden');
                currentClientId = null;
            }
        }

        function openChatWithUser(userId, userName) {
            closeClientCardModal();
            selectUserForChat(userId, userName, '');
            document.getElementById('chat-section')?.scrollIntoView({ behavior: 'smooth' });
        }

        function switchToProjects(userName) {
            closeClientCardModal();
            loadTab('projects');
            showNotification(`Проекты пользователя ${userName}`, 'info');
        }

        function switchToChat(userName) {
            closeClientCardModal();
            showNotification(`Чат с пользователем ${userName}`, 'info');
        }

        // ========== ФУНКЦИИ ДЛЯ ДОГОВОРОВ (МОДАЛЬНЫЕ) ==========
        
        function openContractsModal(userId, userName) {
            currentContractsUserId = userId;
            currentContractsUserName = userName;
            
            const modal = document.getElementById('contracts-modal');
            const clientNameSpan = document.getElementById('contracts-client-name');
            
            if (modal) {
                clientNameSpan.textContent = `Клиент: ${userName}`;
                modal.classList.remove('hidden');
                loadContracts(userId);
            }
        }

        function closeContractsModal() {
            const modal = document.getElementById('contracts-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function loadContracts(userId) {
            const tableBody = document.getElementById('contracts-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Загрузка договоров...</td></tr>';
            
            try {
                const token = localStorage.getItem('access_token');
                setTimeout(() => {
                    const mockContracts = [
                        {
                            id: 1,
                            number: 'ДОГ-2025-001',
                            date: '2025-01-15',
                            type: 'service',
                            typeName: 'На оказание услуг',
                            amount: 150000,
                            status: 'signed',
                            statusName: 'Подписан'
                        },
                        {
                            id: 2,
                            number: 'ДОГ-2025-042',
                            date: '2025-02-10',
                            type: 'development',
                            typeName: 'Разработка ПО',
                            amount: 450000,
                            status: 'in_progress',
                            statusName: 'В работе'
                        }
                    ];
                    
                    let html = '';
                    mockContracts.forEach(contract => {
                        const statusClass = {
                            'draft': 'status-draft',
                            'sent': 'status-sent',
                            'signed': 'status-signed',
                            'completed': 'status-completed',
                            'cancelled': 'status-cancelled'
                        }[contract.status] || 'bg-gray-100 text-gray-800';
                        
                        html += `
                            <tr>
                                <td class="px-4 py-3 font-medium">${contract.number}</td>
                                <td class="px-4 py-3">${new Date(contract.date).toLocaleDateString()}</td>
                                <td class="px-4 py-3">${contract.typeName}</td>
                                <td class="px-4 py-3">${contract.amount.toLocaleString()} ₽</td>
                                <td class="px-4 py-3">
                                    <span class="status-badge ${statusClass}">${contract.statusName}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <button onclick="editContract(${contract.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Редактировать">✏️</button>
                                    <button onclick="viewContract(${contract.id})" class="text-green-600 hover:text-green-800 mr-2" title="Просмотр">👁️</button>
                                    <button onclick="downloadContract(${contract.id})" class="text-purple-600 hover:text-purple-800" title="Скачать">⬇️</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (mockContracts.length === 0) {
                        html = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Нет договоров</td></tr>';
                    }
                    
                    tableBody.innerHTML = html;
                }, 500);
                
            } catch (error) {
                console.error('Ошибка загрузки договоров:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">Ошибка загрузки договоров</td></tr>';
            }
        }

        function createNewContract() {
            const modal = document.getElementById('contract-edit-modal');
            if (!modal) return;
            
            document.getElementById('contract-id').value = '';
            document.getElementById('contract-user-id').value = currentContractsUserId;
            document.getElementById('contract-number').value = '';
            document.getElementById('contract-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('contract-type').value = 'service';
            document.getElementById('contract-amount').value = '';
            document.getElementById('contract-description').value = '';
            document.getElementById('contract-status').value = 'draft';
            document.getElementById('contract-expiry').value = '';
            document.getElementById('contract-file').value = '';
            
            modal.classList.remove('hidden');
        }

        function editContract(contractId) {
            showNotification('Редактирование договора (в разработке)', 'info');
        }

        function viewContract(contractId) {
            showNotification('Просмотр договора (в разработке)', 'info');
        }

        function downloadContract(contractId) {
            showNotification('Скачивание договора (в разработке)', 'info');
        }

        function closeContractEditModal() {
            const modal = document.getElementById('contract-edit-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function saveContract(event) {
            event.preventDefault();
            showNotification('Сохранение договора (в разработке)', 'info');
            closeContractEditModal();
        }

        // ========== ФУНКЦИИ ДЛЯ РЕДАКТИРОВАНИЯ РЕКВИЗИТОВ ==========
        
        async function openClientDetailsModal(userId) {
            const modal = document.getElementById('client-details-modal');
            if (!modal) return;
            
            document.getElementById('details-user-id').value = userId;
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/admin/clients/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const details = await response.json();
                    
                    document.getElementById('company-name').value = details.company_name || '';
                    document.getElementById('legal-address').value = details.legal_address || '';
                    document.getElementById('actual-address').value = details.actual_address || '';
                    document.getElementById('contact-phone').value = details.contact_phone || '';
                    document.getElementById('contact-email').value = details.contact_email || '';
                    document.getElementById('messenger-contact').value = details.messenger_contact || '';
                    document.getElementById('inn').value = details.inn || '';
                    document.getElementById('kpp').value = details.kpp || '';
                    document.getElementById('ogrn').value = details.ogrn || '';
                    document.getElementById('bank-name').value = details.bank_name || '';
                    document.getElementById('bik').value = details.bik || '';
                    document.getElementById('checking-account').value = details.checking_account || '';
                    document.getElementById('correspondent-account').value = details.correspondent_account || '';
                    document.getElementById('director-name').value = details.director_name || '';
                    document.getElementById('director-basis').value = details.director_basis || 'Устава';
                }
            } catch (error) {
                console.error('Ошибка загрузки реквизитов:', error);
            }
            
            modal.classList.remove('hidden');
        }

        function closeClientDetailsModal() {
            const modal = document.getElementById('client-details-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function saveClientDetails(event) {
            event.preventDefault();
            
            const userId = document.getElementById('details-user-id').value;
            if (!userId) return;
            
            const detailsData = {
                company_name: document.getElementById('company-name').value,
                legal_address: document.getElementById('legal-address').value,
                actual_address: document.getElementById('actual-address').value,
                contact_phone: document.getElementById('contact-phone').value,
                contact_email: document.getElementById('contact-email').value,
                messenger_contact: document.getElementById('messenger-contact').value,
                inn: document.getElementById('inn').value,
                kpp: document.getElementById('kpp').value,
                ogrn: document.getElementById('ogrn').value,
                bank_name: document.getElementById('bank-name').value,
                bik: document.getElementById('bik').value,
                checking_account: document.getElementById('checking-account').value,
                correspondent_account: document.getElementById('correspondent-account').value,
                director_name: document.getElementById('director-name').value,
                director_basis: document.getElementById('director-basis').value
            };
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/admin/clients/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(detailsData)
                });
                
                if (response.ok) {
                    showNotification('✅ Реквизиты сохранены', 'success');
                    closeClientDetailsModal();
                    
                    if (currentClientId && !document.getElementById('client-card-modal').classList.contains('hidden')) {
                        await loadClientCardData(currentClientId, currentClientName, currentClientEmail);
                    }
                } else {
                    const error = await response.json();
                    showNotification('❌ Ошибка: ' + (error.detail || 'Неизвестная ошибка'), 'error');
                }
            } catch (error) {
                console.error('Ошибка сохранения реквизитов:', error);
                showNotification('❌ Ошибка при сохранении', 'error');
            }
        }

        // ========== ИНТЕРАКТИВНАЯ ТАБЛИЦА ПРОЕКТОВ ==========
        async function loadProjectsTab(token) {
            try {
                const response = await fetch('/api/admin/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                currentProjects = data.projects || [];
                
                let tableRows = '';
                
                if (currentProjects.length === 0) {
                    tableRows = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                Нет проектов
                            </td>
                        </tr>
                    `;
                } else {
                    currentProjects.forEach(project => {
                        const statusClass = {
                            'pending': 'status-pending',
                            'in_progress': 'status-in_progress',
                            'completed': 'status-completed',
                            'cancelled': 'status-cancelled'
                        }[project.status] || 'bg-gray-100 text-gray-800';
                        
                        const statusText = {
                            'pending': 'Заявка',
                            'in_progress': 'В работе',
                            'completed': 'Выполнен',
                            'cancelled': 'Отменён'
                        }[project.status] || project.status;
                        
                        const safeTitle = (project.title || '').replace(/'/g, "\\'");
                        const safeDescription = (project.description || '').replace(/'/g, "\\'");
                        
                        tableRows += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3 text-black">${project.id}</td>
                                <td class="px-4 py-3">
                                    <div class="project-cell" onclick="toggleCellExpand(this)" title="Нажмите для разворачивания">
                                        ${project.title || '—'}
                                        <span class="expand-icon">🔽</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="project-cell" onclick="toggleCellExpand(this)" title="Нажмите для разворачивания">
                                        ${project.description || '—'}
                                        <span class="expand-icon">🔽</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <button onclick="openProjectFolder(${project.id}, '${safeTitle}')" class="project-folder-btn">
                                        <span>📁</span> Папка проекта
                                    </button>
                                </td>
                                <td class="px-4 py-3">
                                    <select class="status-selector ${statusClass}" onchange="changeProjectStatus(${project.id}, this.value)">
                                        <option value="pending" ${project.status === 'pending' ? 'selected' : ''}>Заявка</option>
                                        <option value="in_progress" ${project.status === 'in_progress' ? 'selected' : ''}>В работе</option>
                                        <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Выполнен</option>
                                        <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}>Отменён</option>
                                    </select>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="project-actions">
                                        <button onclick="addProjectFile(${project.id})" class="bg-green-100 text-green-700 hover:bg-green-200" title="Добавить файл">
                                            ➕
                                        </button>
                                        <button onclick="deleteProjectFile(${project.id})" class="bg-red-100 text-red-700 hover:bg-red-200" title="Удалить файл">
                                            ❌
                                        </button>
                                        <button onclick="viewProjectFiles(${project.id})" class="bg-blue-100 text-blue-700 hover:bg-blue-200" title="Просмотр файлов">
                                            👁️
                                        </button>
                                        <button onclick="editProject(${project.id})" class="bg-purple-100 text-purple-700 hover:bg-purple-200" title="Редактировать проект">
                                            ✏️
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                const content = `
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">Управление проектами</h2>
                        
                        <div class="flex justify-center items-center space-x-6 mb-8">
                            <button onclick="showAddFileModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                <span class="mr-2">➕</span> Добавить файл
                            </button>
                            <button onclick="showAddProjectModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                <span class="mr-2">➕</span> Новый проект
                            </button>
                            <button onclick="showViewFilesModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center justify-center min-w-[200px]">
                                <span class="mr-2">👁️</span> Просмотр файлов
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full data-table">
                                <thead>
                                    <tr>
                                        <th class="text-black">ID</th>
                                        <th class="text-black">Название</th>
                                        <th class="text-black">Описание</th>
                                        <th class="text-black">Папка проекта</th>
                                        <th class="text-black">Статус</th>
                                        <th class="text-black">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="projects-table-body">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
                logToConsole(`📁 Загружено проектов: ${currentProjects.length}`);
                
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error);
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-red-800 font-bold text-lg mb-2">⚠️ Ошибка загрузки проектов</h3>
                        <p class="text-red-600 mb-4">${error.message}</p>
                        <button onclick="loadProjectsTab('${token}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                            Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        function toggleCellExpand(element) {
            element.classList.toggle('expanded');
            const icon = element.querySelector('.expand-icon');
            if (icon) {
                icon.textContent = element.classList.contains('expanded') ? '🔼' : '🔽';
            }
        }

        function openProjectFolder(projectId, projectTitle) {
            loadTab('archive');
            showNotification(`📁 Папка проекта "${projectTitle}" (ID: ${projectId})`, 'info');
            setTimeout(() => {
                const archiveProjectsTab = document.getElementById('archive-projects');
                if (archiveProjectsTab) {
                    archiveProjectsTab.classList.remove('hidden');
                    const archiveServicesTab = document.getElementById('archive-services');
                    if (archiveServicesTab) {
                        archiveServicesTab.classList.add('hidden');
                    }
                }
            }, 500);
        }

        async function changeProjectStatus(projectId, newStatus) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/admin/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showNotification('✅ Статус проекта обновлён', 'success');
                    logToConsole(`📁 Проект ID ${projectId} изменён на статус: ${newStatus}`);
                    loadQuickStats();
                } else {
                    showNotification('❌ Ошибка при обновлении статуса', 'error');
                }
            } catch (error) {
                console.error('Ошибка изменения статуса:', error);
                showNotification('❌ Ошибка при обновлении статуса', 'error');
            }
        }

        function showAddFileModal() {
            showNotification('Функция "Добавить файл" в разработке', 'warning');
        }

        function showAddProjectModal() {
            showNotification('Функция "Новый проект" в разработке', 'warning');
        }

        function showViewFilesModal() {
            showNotification('Функция "Просмотр файлов" в разработке', 'warning');
        }

        function addProjectFile(projectId) {
            showNotification(`Добавление файла к проекту ID ${projectId} (в разработке)`, 'warning');
        }

        function deleteProjectFile(projectId) {
            showNotification(`Удаление файла из проекта ID ${projectId} (в разработке)`, 'warning');
        }

        function viewProjectFiles(projectId) {
            showNotification(`Просмотр файлов проекта ID ${projectId} (в разработке)`, 'warning');
        }

        function editProject(projectId) {
            showNotification(`Редактирование проекта ID ${projectId} (в разработке)`, 'warning');
        }

        // ========== ЗАГЛУШКИ ДЛЯ ОСТАЛЬНЫХ РАЗДЕЛОВ ==========
        async function loadPaymentsTab(token) {
            document.getElementById('content-area').innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Управление платежами</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl">
                            <p class="text-sm text-gray-600">Всего транзакций</p>
                            <p class="text-2xl font-bold text-gray-800" id="total-transactions">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl">
                            <p class="text-sm text-gray-600">Успешные платежи</p>
                            <p class="text-2xl font-bold text-green-600" id="successful-transactions">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-4 rounded-xl">
                            <p class="text-sm text-gray-600">Ожидают</p>
                            <p class="text-2xl font-bold text-yellow-600" id="pending-transactions">0</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Пользователь</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Сумма</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Статус</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Дата</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">Раздел в разработке</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function loadWorkMaterialsTab(token) {
            document.getElementById('content-area').innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Рабочие материалы</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-gray-800">Документация API</h3>
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">PDF</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Полная документация по API для разработчиков</p>
                            <button onclick="showNotification('Функция в разработке', 'warning')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Скачать →</button>
                        </div>
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-gray-800">Шаблоны проектов</h3>
                                <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">ZIP</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Готовые шаблоны для быстрого старта</p>
                            <button onclick="showNotification('Функция в разработке', 'warning')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Скачать →</button>
                        </div>
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-gray-800">Инструкции</h3>
                                <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full">DOC</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Пошаговые инструкции по работе с системой</p>
                            <button onclick="showNotification('Функция в разработке', 'warning')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Скачать →</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadArchiveTab(token) {
            document.getElementById('content-area').innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Архив проектов и услуг</h2>
                    <div class="mb-4 flex space-x-2">
                        <button onclick="showArchiveTab('projects')" class="archive-tab-btn px-4 py-2 bg-purple-600 text-white rounded-lg">Проекты</button>
                        <button onclick="showArchiveTab('services')" class="archive-tab-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Услуги</button>
                    </div>
                    <div id="archive-projects" class="archive-tab">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Название</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Описание</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Статус</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Дата</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Действия</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Раздел в разработке</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="archive-services" class="archive-tab hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Название</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Описание</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Цена</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Дата</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Действия</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Раздел в разработке</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function showArchiveTab(tab) {
            document.querySelectorAll('.archive-tab').forEach(el => el.classList.add('hidden'));
            document.getElementById(`archive-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.archive-tab-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-purple-600', 'text-white');
        }

        // ========== ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ ДОГОВОРОВ С НОВЫМ СТОЛБЦОМ ==========
        async function loadContractsTab(token) {
            logToConsole('📄 Загрузка раздела договоров...');
            
            try {
                // Загружаем список пользователей для фильтра
                const usersResponse = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const usersData = await usersResponse.json();
                const users = usersData.users || [];
                
                // Формируем выпадающий список для фильтра
                let filterOptions = '<option value="all">Все клиенты</option>';
                users.forEach(user => {
                    filterOptions += `<option value="${user.id}">${user.name || 'Без имени'} (${user.email})</option>`;
                });
                
                // Заглушка с данными для демонстрации (11 столбцов)
                const mockContracts = [
                    {
                        id: 1,
                        number: 'ДОГ-2025-001',
                        date: '2025-01-15',
                        client: 'ООО "ТехноПром"',
                        name: 'Разработка веб-портала',
                        description: 'Создание корпоративного портала с личным кабинетом и системой документооборота',
                        progress: 75,
                        completion_date: '2025-06-15',
                        amount: 450000,
                        status_percent: 75,
                        current_task: 'Интеграция с CRM',
                        status: 'active'
                    },
                    {
                        id: 2,
                        number: 'ДОГ-2025-042',
                        date: '2025-02-10',
                        client: 'ИП Иванов А.А.',
                        name: 'Мобильное приложение',
                        description: 'Разработка iOS и Android приложения для интернет-магазина',
                        progress: 30,
                        completion_date: '2025-08-20',
                        amount: 780000,
                        status_percent: 30,
                        current_task: 'Проектирование базы данных',
                        status: 'active'
                    },
                    {
                        id: 3,
                        number: 'ДОГ-2024-128',
                        date: '2024-11-05',
                        client: 'АО "СтройИнвест"',
                        name: 'Автоматизация отчетности',
                        description: 'Внедрение системы автоматической генерации финансовых отчетов',
                        progress: 100,
                        completion_date: '2025-02-05',
                        amount: 320000,
                        status_percent: 100,
                        current_task: 'Завершен',
                        status: 'completed'
                    },
                    {
                        id: 4,
                        number: 'ДОГ-2025-089',
                        date: '2025-03-01',
                        client: 'ООО "МедиаГрупп"',
                        name: 'SEO-оптимизация',
                        description: 'Комплексная SEO-оптимизация сайта и контент-маркетинг',
                        progress: 15,
                        completion_date: '2025-07-01',
                        amount: 180000,
                        status_percent: 15,
                        current_task: 'Аудит текущего состояния',
                        status: 'draft'
                    },
                    {
                        id: 5,
                        number: 'ДОГ-2024-256',
                        date: '2024-09-20',
                        client: 'ЧУ ДПО "Образование+"',
                        name: 'Разработка LMS',
                        description: 'Создание платформы для дистанционного обучения с видео-лекциями и тестами',
                        progress: 100,
                        completion_date: '2025-01-20',
                        amount: 950000,
                        status_percent: 100,
                        current_task: 'Завершен',
                        status: 'completed'
                    },
                    {
                        id: 6,
                        number: 'ДОГ-2025-103',
                        date: '2025-03-15',
                        client: 'ООО "ЛогистикПро"',
                        name: 'Система управления складом',
                        description: 'Разработка WMS для автоматизации складских процессов',
                        progress: 10,
                        completion_date: '2025-09-15',
                        amount: 1250000,
                        status_percent: 10,
                        current_task: 'Сбор требований',
                        status: 'draft'
                    }
                ];
                
                // Формируем строки таблицы (11 столбцов)
                let tableRows = '';
                mockContracts.forEach(contract => {
                    const statusClass = {
                        'draft': 'status-draft',
                        'active': 'status-active',
                        'completed': 'status-completed',
                        'cancelled': 'status-cancelled'
                    }[contract.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'draft': 'Черновик',
                        'active': 'В работе',
                        'completed': 'Завершён',
                        'cancelled': 'Отменён'
                    }[contract.status] || contract.status;
                    
                    // Рассчитываем полученную оплату (процент от суммы)
                    const paidAmount = Math.round(contract.amount * (contract.status_percent / 100));
                    
                    tableRows += `
                        <tr>
                            <td class="font-medium text-gray-900">${contract.number}</td>
                            <td>${new Date(contract.date).toLocaleDateString('ru-RU')}</td>
                            <td><span class="font-medium">${contract.client}</span></td>
                            <td>
                                <div class="contract-cell" onclick="toggleCellExpand(this)" title="Нажмите для разворачивания">
                                    ${contract.name}
                                    <span class="expand-icon">🔽</span>
                                </div>
                            </td>
                            <td>
                                <div class="contract-cell" onclick="toggleCellExpand(this)" title="Нажмите для разворачивания">
                                    ${contract.description}
                                    <span class="expand-icon">🔽</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: ${contract.progress}%"></div>
                                    </div>
                                    <span class="text-xs font-medium">${contract.progress}%</span>
                                </div>
                            </td>
                            <td>${new Date(contract.completion_date).toLocaleDateString('ru-RU')}</td>
                            <td class="font-medium">${contract.amount.toLocaleString()} ₽</td>
                            <td class="font-medium text-green-600">${paidAmount.toLocaleString()} ₽</td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <span class="font-medium">${contract.status_percent}%</span>
                                    <span class="contract-status-badge ${statusClass}">${statusText}</span>
                                </div>
                            </td>
                            <td>
                                <div class="contract-cell" onclick="toggleCellExpand(this)" title="Нажмите для разворачивания">
                                    ${contract.current_task}
                                    <span class="expand-icon">🔽</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                // ФОРМИРУЕМ ПОЛНОСТЬЮ ВЁРСТКУ СТРАНИЦЫ
                const content = `
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Управление договорами</h2>
                        
                        <!-- Кнопка "Новый договор" и фильтр сверху -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="filter-section flex-1 mr-4">
                                <div class="flex items-center gap-4">
                                    <span class="text-sm font-medium text-gray-700">Фильтр по клиенту:</span>
                                    <select id="contract-client-filter" class="p-2 border rounded-lg text-sm flex-1 max-w-xs" onchange="filterContracts()">
                                        ${filterOptions}
                                    </select>
                                </div>
                            </div>
                            <button onclick="createNewContract()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl transition-colors flex items-center">
                                <span class="mr-2">➕</span> Новый договор
                            </button>
                        </div>
                        
                        <!-- Таблица с горизонтальной прокруткой -->
                        <div class="contracts-table-wrapper">
                            <div class="contracts-table-scroll">
                                <table class="contracts-table">
                                    <thead>
                                        <tr>
                                            <th>№ договора</th>
                                            <th>Дата</th>
                                            <th>Заказчик</th>
                                            <th>Название договора</th>
                                            <th>Описание задачи</th>
                                            <th>Прогресс выполнения</th>
                                            <th>Дата завершения</th>
                                            <th>Сумма</th>
                                            <th>Полученная оплата</th>
                                            <th>Статус</th>
                                            <th>Текущая задача</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contracts-table-body">
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Если нет договоров -->
                        ${mockContracts.length === 0 ? `
                            <div class="text-center py-12">
                                <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-gray-500 text-lg">Нет договоров</p>
                                <p class="text-gray-400 text-sm mt-2">Нажмите "Новый договор" для создания</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
                logToConsole(`📄 Загружено договоров: ${mockContracts.length}`);
                
            } catch (error) {
                console.error('Ошибка загрузки договоров:', error);
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-red-800 font-bold text-lg mb-2">⚠️ Ошибка загрузки договоров</h3>
                        <p class="text-red-600 mb-4">${error.message}</p>
                        <button onclick="loadContractsTab('${token}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                            Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        // Функция фильтрации договоров по клиенту
        function filterContracts() {
            const filterValue = document.getElementById('contract-client-filter').value;
            showNotification(`Фильтр по клиенту ID: ${filterValue} (в разработке)`, 'info');
            // Здесь будет логика фильтрации
        }
    </script>
</body>
</html>



